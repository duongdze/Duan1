<?php
// models/TourLog.php
require_once 'models/BaseModel.php';

class TourLog extends BaseModel
{
    protected $table = 'tour_logs';

    public function all(): array
    {
        $stmt = self::$pdo->query("
            SELECT tl.*, t.name AS tour_name, u.full_name AS guide_name
            FROM tour_logs tl
            JOIN tours t ON t.id = tl.tour_id
            JOIN guides g ON g.id = tl.guide_id
            JOIN users u ON u.user_id = g.user_id
            ORDER BY tl.date DESC
        ");
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public function findById($id): ?array
    {
        $stmt = self::$pdo->prepare("SELECT * FROM tour_logs WHERE id = :id");
        $stmt->execute(['id' => $id]);
        return $stmt->fetch(PDO::FETCH_ASSOC) ?: null;
    }

    public function create(array $data): bool
    {
        $sql = "INSERT INTO tour_logs 
        (tour_id, guide_id, date, description, issue, solution, customer_feedback, weather, incident, health_status, special_activity, handling_notes, guide_rating) 
        VALUES 
        (:tour_id, :guide_id, :date, :description, :issue, :solution, :customer_feedback, :weather, :incident, :health_status, :special_activity, :handling_notes, :guide_rating)";

        $stmt = self::$pdo->prepare($sql);
        return $stmt->execute($data);
    }


    public function updateLog($id, array $data): bool
    {
        $sql = "UPDATE tour_logs SET
            tour_id = :tour_id,
            guide_id = :guide_id,
            date = :date,
            description = :description,
            issue = :issue,
            solution = :solution,
            customer_feedback = :customer_feedback,
            weather = :weather,
            incident = :incident,
            health_status = :health_status,
            special_activity = :special_activity,
            handling_notes = :handling_notes,
            guide_rating = :guide_rating
            WHERE id = :id";
        $data['id'] = $id;
        $stmt = self::$pdo->prepare($sql);
        return $stmt->execute($data);
    }

    public function deleteById($id): bool
    {
        $stmt = self::$pdo->prepare("DELETE FROM tour_logs WHERE id = :id");
        return $stmt->execute(['id' => $id]);
    }

    public function getLogsByTourId($tourId)
    {
        $sql = "SELECT tl.*, u.full_name as guide_name 
                FROM {$this->table} tl
                LEFT JOIN guides g ON tl.guide_id = g.id
                LEFT JOIN users u ON g.user_id = u.user_id
                WHERE tl.tour_id = :tour_id
                ORDER BY tl.date DESC";
        $stmt = self::$pdo->prepare($sql);
        $stmt->execute(['tour_id' => $tourId]);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public function getToursWithLogStats()
    {
        $sql = "SELECT t.id, t.name, 
                       COUNT(tl.id) as log_count, 
                       MAX(tl.date) as last_log_date
                FROM tours t
                LEFT JOIN tour_logs tl ON t.id = tl.tour_id
                GROUP BY t.id, t.name
                ORDER BY last_log_date DESC";
        $stmt = self::$pdo->prepare($sql);
        $stmt->execute();
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
}
